# iOS Setup for flutter_blue

This document explains how to set up and troubleshoot the flutter_blue package for iOS development.

## Protobuf Files Issue

If you encounter errors like:
```
This file was generated by a newer version of protoc which is incompatible with your Protocol Buffer library sources.
```
or
```
Unknown type name 'GPB_FINAL'
```

These errors occur due to version incompatibility between the protoc compiler and the Protobuf library.

### Prerequisites

Install a compatible Protocol Buffer Compiler:

**macOS:**
```bash
# Install protobuf version 21 for compatibility
brew install protobuf@21

# If you have a newer version already installed, you may need to:
# brew unlink protobuf
# brew link protobuf@21
```

**Linux (Ubuntu/Debian):**
```bash
# Install specific version for compatibility
sudo apt-get install protobuf-compiler=3.21.*
```

**Manual Installation:**
Download protoc 3.21.x from [Protocol Buffers releases](https://github.com/protocolbuffers/protobuf/releases/tag/v21.12)

### Automatic Fix (Recommended)

If you're using this package from pub cache, run the setup script:

```bash
# Navigate to the flutter_blue package directory in pub cache
cd ~/.pub-cache/git/flutter_blue-[hash]/
# or if using path dependency, navigate to your local flutter_blue directory

# Run the setup script
ios/Scripts/setup_protobuf.sh
```

The script will automatically detect and use the compatible protoc@21 version if available.

### Manual Fix

If the automatic script doesn't work:

1. Navigate to the flutter_blue package directory
2. Use the compatible protoc version:
   ```bash
   # Create directories if they don't exist
   mkdir -p ios/gen lib/gen
   
   # Generate protobuf files with compatible protoc
   cd protos
   
   # macOS with protobuf@21
   /opt/homebrew/opt/protobuf@21/bin/protoc --objc_out=../ios/gen ./flutterblue.proto
   /opt/homebrew/opt/protobuf@21/bin/protoc --dart_out=../lib/gen ./flutterblue.proto
   
   # or with system protoc if version 21.x
   protoc --objc_out=../ios/gen ./flutterblue.proto
   protoc --dart_out=../lib/gen ./flutterblue.proto
   ```

### Version Compatibility

- **protoc 3.21.x** ↔ **Protobuf library ~> 3.21.0** ✅
- **protoc 25.x+** ↔ **Protobuf library ~> 3.11.4** ❌
- **protoc 29.x+** ↔ **Protobuf library ~> 3.21.0** ❌

### For Package Developers

When contributing to flutter_blue:

1. Use protobuf@21 to ensure compatibility
2. Always regenerate protobuf files after modifying `protos/flutterblue.proto`
3. Run `ios/Scripts/setup_protobuf.sh` to ensure all files are up to date
4. Commit the generated files to the repository

### Troubleshooting

1. **"protoc: command not found"**
   ```bash
   brew install protobuf@21
   ```

2. **"This file was generated by a newer version of protoc"**
   - The protoc version is too new for the Protobuf library
   - Use protobuf@21: `brew install protobuf@21`
   - Regenerate files with the compatible protoc

3. **"Unknown type name 'GPB_FINAL'"**
   - The Protobuf library version is too old for the generated files
   - Update your project's Protobuf dependency to ~> 3.21.0
   - Or regenerate files with an older protoc version

4. **Permission denied when running script**
   ```bash
   chmod +x ios/Scripts/setup_protobuf.sh
   ```

5. **Files still missing after generation**
   - Verify the files exist in `ios/gen/` and `lib/gen/`
   - Clean and rebuild your iOS project
   - Delete derived data and rebuild

6. **Build errors related to protobuf**
   - Ensure Protobuf framework version matches generated files
   - Check that `GPB_USE_PROTOBUF_FRAMEWORK_IMPORTS=1` is set in build settings
   - Clean pod cache: `cd ios && pod cache clean --all && pod install`

### Integration with Existing Projects

When adding flutter_blue to an existing project:

1. Ensure compatible Protobuf version in your Podfile.lock
2. If you have protobuf version conflicts, run:
   ```bash
   cd ios
   pod cache clean --all
   pod install
   ```
3. The podspec includes a script phase that should automatically generate protobuf files
4. Manual generation may be needed in some cases using the setup script

### Common Version Issues

If you see these specific errors in Xcode:

- **Error 30007**: protoc is too new, use protobuf@21
- **GPB_FINAL undefined**: Protobuf library is too old, update to ~> 3.21.0
- **Framework not found**: Clean and rebuild, check Protobuf dependency
